branches:
  only:
    - staging
    - master
    - trying

sudo: required
language: rust

services:
  - docker

cache: cargo

rust:
  - stable

# the main build
script:
  - |
    cargo build &&
    cargo test
  - |
    if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then
      pushd secsp_fuzzer/
      cargo afl build
      timeout 10m cargo afl fuzz -i ../examples -o out target/debug/secsp-fuzzer > /dev/null || true
      cat out/fuzzer_stats
      grep "unique_crashes *: 0" out/fuzzer_stats
      popd
    else
      echo "Building pull request, not running AFL."
    fi

after_success:
  - docker pull xd009642/tarpaulin:develop-nightly
  - docker run --security-opt seccomp=unconfined -v "$PWD:/volume" xd009642/tarpaulin:develop-nightly sh -c "cargo tarpaulin --out Xml"
  - bash <(curl -s https://codecov.io/bash)
